#!/bin/bash

echo -e "\e[44mMake shure you run this command in the utilities folder\e[0m"

_file="${HOME}/.bashrc"
_tmp="${HOME}/.tmp"

# Define some start and end quotes for detecting the MuRoX defines
_start="# ##### MuRoX start -- DO NOT EDIT #####"
_end="# ##### MuRoX end #####"

# Some checks
if [ ! -e $_file ]
then
  echo -e "\e[41m${_file} does not exist\e[0m"
  exit 1
fi

touch $_tmp 2>/dev/null
if [ ! -w "$_tmp" ]
then
  echo -e "\e[41mCan not create temporary file ${_tmp}\e[0m"
  exit 2
fi

# Chop the old block if it exists
_line_start=`grep -x -n "$_start" "$_file" | cut -f1 -d:`
_line_end=`grep -x -n "$_end" "$_file" | cut -f1 -d:`
_lines=`wc -l < $_file`

if [[ "$_line_start" != "" ]]
then
    echo -e "\e[42mChopping out old MuRoX definition in ${_file}\e[0m"
    head -n`expr $_line_start - 1` $_file > $_tmp
    tail -n`expr $_lines - $_line_end` $_file >> $_tmp
else
    echo -e "\e[42mNo old MuRoX definition found in ${_file}\e[0m"
    cp $_file $_tmp
fi

# Set the MuRoX defines
echo -e "\e[42mInit the utilities for global usage in bash\e[0m"
echo "${_start}" >> "$_tmp"
echo "export PATH=${PWD}:\$PATH" >> "$_tmp"
echo -e "\e[42mSet environment variables with MUROX_ prefix\e[0m"
# Go to folder murox_dev and set the environment variables
cd ../..
echo "export MUROX_ENV=${PWD}" >> "$_tmp"
echo "export MUROX_DOKU=${PWD}/dokuwiki" >> "$_tmp"
echo "export MUROX_PROJECT=${PWD}/project" >> "$_tmp"
echo "export MUROX_INCLUDE_DIRS=${PWD}/project/includes" >> "$_tmp"
echo "export MUROX_CMAKE_MODULES=${PWD}/project/utilities/cmake" >> "$_tmp"
echo "${_end}" >> "$_tmp"

# Replace and cleanup the old file
mv $_tmp $_file

echo -e "\e[42mDONE -- Source your ${_file} to use MuRoX\e[0m"